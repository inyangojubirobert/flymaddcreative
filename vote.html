<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - One Dream Initiative | FlyMadd Creative</title>
    <meta name="description" content="Support your favorite participant in the One Dream Initiative. Cast your vote and help make dreams come true.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        accent: {
                            500: '#8b5cf6',
                            600: '#7c3aed'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'gradient': 'gradient 8s ease infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        gradient: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Enhanced CSS Styles -->
    <style>
        body {
            background: linear-gradient(-45deg, #1e3a8a, #3b82f6, #8b5cf6, #ec4899);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
        }
        
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite;
        }
        
        .vote-card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .vote-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .participant-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: float 4s ease-in-out infinite;
        }
        
        .vote-button {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .vote-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }
        
        .vote-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .vote-button:hover::before {
            left: 100%;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            animation: gradient 2s ease infinite;
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hidden { display: none; }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .payment-method-btn {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-method-btn:hover {
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .payment-method-btn.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.3);
        }
        
        .payment-method-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body class="text-white">
    <!-- Navigation -->
    <nav class="glassmorphism border-b border-white/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="text-xl font-bold gradient-text">
                        FlyMadd Creative
                    </a>
                    <span class="text-white/60">|</span>
                    <span class="text-white font-medium">One Dream Initiative</span>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="Onedream.html" class="text-white/80 hover:text-white transition-colors">Dashboard</a>
                    <a href="search.html" class="text-white/80 hover:text-white transition-colors">Find Participant</a>
                    <a href="leadershipBoard.html" class="text-white/80 hover:text-white transition-colors">Leaderboard</a>
                    <a href="registration.html" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        Join Initiative
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-2xl w-full">
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center mb-8">
                <div class="glassmorphism rounded-2xl p-8 fade-in">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <h2 class="text-2xl font-bold mb-2">Loading Participant...</h2>
                    <p class="text-white/80">Please wait while we fetch the details</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden text-center mb-8">
                <div class="glassmorphism rounded-2xl p-8 fade-in border-red-500/30">
                    <div class="text-red-400 text-6xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-2xl font-bold mb-2 text-red-300">Participant Not Found</h2>
                    <p class="text-white/80 mb-6" id="errorMessage">
                        We couldn't find the participant you're looking for.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <a href="search.html" 
                           class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors">
                            üîç Find Participant
                        </a>
                        <a href="leadershipBoard.html" 
                           class="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg transition-colors">
                            üìä View Leaderboard
                        </a>
                        <a href="registration.html" 
                           class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                            ‚ûï Join Initiative
                        </a>
                    </div>
                </div>
            </div>

            <!-- Participant Card -->
            <div id="participantCard" class="hidden">
                <!-- Header -->
                <div class="text-center mb-8 fade-in">
                    <h1 class="text-4xl md:text-5xl font-bold gradient-text mb-4">
                        Cast Your Vote
                    </h1>
                    <p class="text-xl text-white/80">
                        Support this participant's dream in the One Dream Initiative
                    </p>
                </div>

                <!-- Participant Details -->
                <div class="glassmorphism rounded-2xl p-8 mb-8 vote-card">
                    <div class="flex flex-col md:flex-row items-center gap-8">
                        <!-- Avatar -->
                        <div class="participant-avatar w-32 h-32 rounded-full flex items-center justify-center text-4xl font-bold text-white">
                            <span id="participantInitials">?</span>
                        </div>
                        
                        <!-- Details -->
                        <div class="flex-1 text-center md:text-left">
                            <h2 class="text-3xl font-bold mb-2" id="participantName">Loading...</h2>
                            <p class="text-xl text-blue-300 mb-2">@<span id="participantUsername">username</span></p>
                            <p class="text-white/80 mb-4" id="participantEmail">email@example.com</p>
                            
                            <!-- Stats -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="bg-white/10 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold" id="currentVotes">0</div>
                                    <div class="text-sm text-white/70">Current Votes</div>
                                </div>
                                <div class="bg-white/10 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold" id="participantRank">#1</div>
                                    <div class="text-sm text-white/70">Leaderboard Rank</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm mb-2">
                                    <span>Progress to Goal</span>
                                    <span id="progressPercentage">0%</span>
                                </div>
                                <div class="w-full bg-white/20 rounded-full h-3">
                                    <div class="progress-bar h-3 rounded-full transition-all duration-1000" 
                                         id="progressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Voting Section -->
                <div class="glassmorphism rounded-2xl p-8 mb-8">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold mb-4">Support This Dream</h3>
                        <p class="text-white/80 mb-6">
                            Each vote costs $2 and brings this participant closer to their goal of 1 million votes.
                        </p>
                        
                        <!-- Vote Amount Selection -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <button class="vote-amount-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                    data-amount="1" data-cost="2">
                                <div class="text-xl font-bold">1 Vote</div>
                                <div class="text-sm text-white/70">$2.00</div>
                            </button>
                            <button class="vote-amount-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                    data-amount="5" data-cost="10">
                                <div class="text-xl font-bold">5 Votes</div>
                                <div class="text-sm text-white/70">$10.00</div>
                            </button>
                            <button class="vote-amount-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                    data-amount="10" data-cost="20">
                                <div class="text-xl font-bold">10 Votes</div>
                                <div class="text-sm text-white/70">$20.00</div>
                            </button>
                            <button class="vote-amount-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                    data-amount="25" data-cost="50">
                                <div class="text-xl font-bold">25 Votes</div>
                                <div class="text-sm text-white/70">$50.00</div>
                            </button>
                        </div>
                        
                        <!-- Custom Amount -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Custom Vote Amount</label>
                            <input type="number" id="customVoteAmount" min="1" max="1000" 
                                   class="w-full bg-white/10 border border-white/30 rounded-lg px-4 py-3 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Enter number of votes">
                            <p class="text-sm text-white/60 mt-2">
                                Total cost: $<span id="totalCost">2.00</span>
                            </p>
                        </div>

                        <!-- Payment Method Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-4 text-center">Choose Payment Method</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button class="payment-method-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent active"
                                        data-method="stripe" id="stripeBtn">
                                    <div class="text-3xl mb-2">üí≥</div>
                                    <div class="font-bold">Credit Card</div>
                                    <div class="text-sm text-white/70">Stripe Secure</div>
                                </button>
                                <button class="payment-method-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                        data-method="paystack" id="paystackBtn">
                                    <div class="text-3xl mb-2">üè¶</div>
                                    <div class="font-bold">Bank Transfer</div>
                                    <div class="text-sm text-white/70">PayStack</div>
                                </button>
                                <button class="payment-method-btn bg-white/20 hover:bg-white/30 p-4 rounded-lg transition-all border-2 border-transparent"
                                        data-method="crypto" id="cryptoBtn">
                                    <div class="text-3xl mb-2">‚Çø</div>
                                    <div class="font-bold">Cryptocurrency</div>
                                    <div class="text-sm text-white/70">BTC/ETH/USDT</div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Vote Button -->
                        <button id="voteButton" class="vote-button w-full py-4 px-8 rounded-xl text-white font-bold text-lg transition-all duration-300 disabled:opacity-50">
                            <span id="voteButtonText">Purchase Votes - $2.00</span>
                            <div id="voteButtonSpinner" class="loading-spinner hidden inline-block ml-2"></div>
                        </button>
                        
                        <!-- Payment Methods -->
                        <div class="mt-6 text-center">
                            <p class="text-sm text-white/60 mb-3">Secure payment powered by</p>
                            <div class="flex justify-center items-center space-x-6">
                                <span class="text-lg font-bold text-blue-400">Stripe</span>
                                <span class="text-white/40">‚Ä¢</span>
                                <span class="text-lg font-bold text-green-400">PayStack</span>
                                <span class="text-white/40">‚Ä¢</span>
                                <span class="text-lg font-bold text-orange-400">Crypto</span>
                            </div>
                            <p class="text-xs text-white/50 mt-2">
                                Choose your preferred payment method above
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Share Section -->
                <div class="glassmorphism rounded-2xl p-8">
                    <div class="text-center">
                        <h3 class="text-xl font-bold mb-4">Share & Support</h3>
                        <p class="text-white/80 mb-6">
                            Help spread the word about this participant's journey
                        </p>
                        
                        <div class="flex justify-center space-x-4">
                            <button onclick="shareOnTwitter()" 
                                    class="bg-blue-500 hover:bg-blue-600 p-3 rounded-lg transition-colors">
                                üê¶ Twitter
                            </button>
                            <button onclick="shareOnFacebook()" 
                                    class="bg-blue-700 hover:bg-blue-800 p-3 rounded-lg transition-colors">
                                üìò Facebook
                            </button>
                            <button onclick="copyVoteLink()" 
                                    class="bg-gray-600 hover:bg-gray-700 p-3 rounded-lg transition-colors">
                                üîó Copy Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glassmorphism rounded-2xl p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-2xl font-bold mb-4">Payment Successful!</h3>
            <p class="text-white/80 mb-6">
                Thank you for supporting <span id="successParticipantName">this participant</span>!
                Your payment for <span id="successVoteCount">1</span> vote(s) has been processed successfully.
            </p>
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="closeSuccessModal()" 
                        class="bg-white/20 hover:bg-white/30 px-6 py-3 rounded-lg transition-colors">
                    Purchase More Votes
                </button>
                <a href="leadershipBoard.html" 
                   class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition-colors">
                    View Leaderboard
                </a>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // üîß SECURE CONFIGURATION
        // ========================================
        
        // üîê Load configuration securely from API endpoint
        let supabase = null;
        let DEMO_MODE = true; // Start in demo mode until config loads
        let currentParticipant = null;
        let selectedVoteAmount = 1;
        let selectedCost = 2.00;
        let selectedPaymentMethod = 'stripe'; // Default payment method
        
        // Load configuration from secure endpoint
        async function loadConfig() {
            try {
                // Since we don't have an API server, skip the config loading and use demo mode
                console.log('üé≠ No API server available, using demo mode');
                DEMO_MODE = true;
                return;
                
                // Original code kept for reference when API is available:
                // const response = await fetch('/api/config');
                // if (!response.ok) throw new Error('Failed to load config');
                // 
                // const config = await response.json();
                // 
                // // Initialize Supabase with loaded config
                // if (window.supabase && window.supabase.createClient) {
                //     supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey, {
                //         auth: {
                //             persistSession: true,
                //             autoRefreshToken: true,
                //         }
                //     });
                //     DEMO_MODE = false;
                //     console.log('‚úÖ Supabase initialized with secure config');
                // } else {
                //     throw new Error('Supabase library not loaded');
                // }
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to load secure config, using demo mode:', error);
                DEMO_MODE = true;
            }
        }
        
        // ========================================
        // üìù APPLICATION CODE
        // ========================================

        document.addEventListener('DOMContentLoaded', async function() {
            // Load secure configuration first
            await loadConfig();
            
            // Get participant from URL - support multiple parameter formats
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('user') || urlParams.get('username');
            const userCode = urlParams.get('code') || urlParams.get('user_code');
            
            if (!username && !userCode) {
                showError('No participant specified in URL. Please provide either username or user code.');
                return;
            }
            
            // Load participant data
            if (userCode) {
                await loadParticipantByCode(userCode);
            } else {
                await loadParticipant(username);
            }
            
            // Initialize vote amount selection
            initializeVoteSelection();
            
            // Initialize vote button
            document.getElementById('voteButton').addEventListener('click', handleVote);
        });

        async function loadParticipantByCode(userCode) {
            try {
                if (DEMO_MODE) {
                    await simulateParticipantLoadByCode(userCode);
                } else {
                    await loadParticipantFromSupabaseByCode(userCode);
                }
                
                showParticipant();
                
            } catch (error) {
                console.error('Failed to load participant by code:', error);
                showError(`Failed to load participant: ${error.message}`);
            }
        }

        async function simulateParticipantLoadByCode(userCode) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Demo participants by user code
            const demoParticipants = {
                'ABC123XY': {
                    id: 1001,
                    name: 'John Demo User',
                    username: 'johndemo',
                    email: 'john@example.com',
                    user_code: 'ABC123XY',
                    total_votes: 245,
                    rank: 15,
                    created_at: new Date().toISOString()
                },
                'DEF456ZW': {
                    id: 1002,
                    name: 'Sarah Demo User',
                    username: 'sarahdemo',
                    email: 'sarah@example.com',
                    user_code: 'DEF456ZW',
                    total_votes: 189,
                    rank: 23,
                    created_at: new Date().toISOString()
                },
                'GHI789UV': {
                    id: 1003,
                    name: 'Mike Demo User',
                    username: 'mikedemo',
                    email: 'mike@example.com',
                    user_code: 'GHI789UV',
                    total_votes: 567,
                    rank: 8,
                    created_at: new Date().toISOString()
                }
            };
            
            const participant = demoParticipants[userCode.toUpperCase()];
            
            if (participant) {
                currentParticipant = participant;
                console.log('üé≠ Demo participant loaded by code:', currentParticipant);
            } else {
                throw new Error(`Participant not found with code: ${userCode}. Try ABC123XY, DEF456ZW, or GHI789UV`);
            }
        }

        async function loadParticipantFromSupabaseByCode(userCode) {
            const { data: participant, error } = await supabase
                .from('participants')
                .select(`
                    id,
                    name,
                    username,
                    email,
                    user_code,
                    total_votes,
                    created_at
                `)
                .eq('user_code', userCode)
                .single();

            if (error) {
                if (error.code === 'PGRST116') {
                    throw new Error('Participant not found');
                }
                throw error;
            }

            // Get rank (simplified - in production you'd use a view or function)
            const { data: rankData } = await supabase
                .from('participants')
                .select('id')
                .gt('total_votes', participant.total_votes);
            
            participant.rank = (rankData?.length || 0) + 1;
            currentParticipant = participant;
        }
            try {
                if (DEMO_MODE) {
                    await simulateParticipantLoad(username);
                } else {
                    await loadParticipantFromSupabase(username);
                }
                
                showParticipant();
                
            } catch (error) {
                console.error('Failed to load participant:', error);
                showError(`Failed to load participant: ${error.message}`);
            }
        

        async function loadParticipant(username) {
            try {
                if (DEMO_MODE) {
                    await simulateParticipantLoad(username);
                } else {
                    await loadParticipantFromSupabase(username);
                }
                
                showParticipant();
                
            } catch (error) {
                console.error('Failed to load participant:', error);
                showError(`Failed to load participant: ${error.message}`);
            }
        }

        async function simulateParticipantLoad(username) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Generate mock participant data
            currentParticipant = {
                id: Math.floor(Math.random() * 10000),
                name: username.charAt(0).toUpperCase() + username.slice(1) + ' Demo User',
                username: username,
                email: `${username}@example.com`,
                user_code: generateUserCode(),
                total_votes: Math.floor(Math.random() * 1000),
                rank: Math.floor(Math.random() * 50) + 1,
                created_at: new Date().toISOString()
            };
            
            console.log('üé≠ Demo participant loaded:', currentParticipant);
        }

        async function loadParticipantFromSupabase(username) {
            const { data: participant, error } = await supabase
                .from('participants')
                .select(`
                    id,
                    name,
                    username,
                    email,
                    user_code,
                    total_votes,
                    created_at
                `)
                .eq('username', username)
                .single();

            if (error) {
                if (error.code === 'PGRST116') {
                    throw new Error('Participant not found');
                }
                throw error;
            }

            // Get rank (simplified - in production you'd use a view or function)
            const { data: rankData } = await supabase
                .from('participants')
                .select('id')
                .gt('total_votes', participant.total_votes);
            
            participant.rank = (rankData?.length || 0) + 1;
            currentParticipant = participant;
        }

        function showParticipant() {
            if (!currentParticipant) return;
            
            // Hide loading, show participant card
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('participantCard').classList.remove('hidden');
            
            // Populate participant details
            document.getElementById('participantName').textContent = currentParticipant.name;
            document.getElementById('participantUsername').textContent = currentParticipant.username;
            document.getElementById('participantEmail').textContent = currentParticipant.email;
            document.getElementById('currentVotes').textContent = currentParticipant.total_votes.toLocaleString();
            document.getElementById('participantRank').textContent = `#${currentParticipant.rank}`;
            
            // Generate initials for avatar
            const initials = currentParticipant.name
                .split(' ')
                .map(n => n.charAt(0))
                .join('')
                .toUpperCase()
                .slice(0, 2);
            document.getElementById('participantInitials').textContent = initials;
            
            // Calculate progress (goal is 1M votes)
            const goal = 1000000;
            const progressPercent = Math.min((currentParticipant.total_votes / goal) * 100, 100);
            document.getElementById('progressPercentage').textContent = `${progressPercent.toFixed(1)}%`;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            
            // Update page title
            document.title = `Vote for ${currentParticipant.name} - One Dream Initiative`;
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('participantCard').classList.add('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        function initializeVoteSelection() {
            const buttons = document.querySelectorAll('.vote-amount-btn');
            const customInput = document.getElementById('customVoteAmount');
            
            // Pre-select first option (1 vote, $2)
            buttons[0].classList.add('border-blue-500', 'bg-blue-500/30');
            selectedVoteAmount = 1;
            selectedCost = 2.00;
            updateUI();
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Clear all selections
                    buttons.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'bg-blue-500/30');
                    });
                    customInput.value = '';
                    
                    // Select this button
                    this.classList.add('border-blue-500', 'bg-blue-500/30');
                    selectedVoteAmount = parseInt(this.dataset.amount);
                    selectedCost = parseFloat(this.dataset.cost);
                    updateUI();
                });
            });
            
            customInput.addEventListener('input', function() {
                // Clear button selections
                buttons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-500/30');
                });
                
                selectedVoteAmount = parseInt(this.value) || 1;
                selectedCost = selectedVoteAmount * 2.00; // $2 per vote
                updateUI();
            });

            // Initialize payment method selection
            initializePaymentMethods();
        }

        function initializePaymentMethods() {
            const paymentButtons = document.querySelectorAll('.payment-method-btn');
            
            paymentButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Clear all selections
                    paymentButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Select this payment method
                    this.classList.add('active');
                    selectedPaymentMethod = this.dataset.method;
                    updateUI();
                });
            });
        }

        function updateUI() {
            document.getElementById('totalCost').textContent = selectedCost.toFixed(2);
            document.getElementById('voteButtonText').textContent = `Purchase ${selectedVoteAmount} Vote${selectedVoteAmount > 1 ? 's' : ''} - $${selectedCost.toFixed(2)}`;
        }

        async function handleVote() {
            if (!currentParticipant || selectedVoteAmount <= 0) {
                alert('Please select a valid vote amount');
                return;
            }
            
            const voteButton = document.getElementById('voteButton');
            const buttonText = document.getElementById('voteButtonText');
            const spinner = document.getElementById('voteButtonSpinner');
            
            // Show loading state
            voteButton.disabled = true;
            buttonText.textContent = 'Processing Payment...';
            spinner.classList.remove('hidden');
            
            try {
                if (DEMO_MODE) {
                    await simulatePaymentAndVote();
                } else {
                    await processPaymentAndVote();
                }
                
                showSuccessModal();
                
            } catch (error) {
                console.error('Vote processing failed:', error);
                alert(`Payment failed: ${error.message}`);
            } finally {
                // Reset button state
                voteButton.disabled = false;
                updateUI();
                spinner.classList.add('hidden');
            }
        }

        async function simulatePaymentAndVote() {
            // Simulate payment processing delay
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            // Update local participant data
            currentParticipant.total_votes += selectedVoteAmount;
            
            console.log(`üé≠ Demo payment: $${selectedCost} for ${selectedVoteAmount} votes for ${currentParticipant.username}`);
        }

        async function processPaymentAndVote() {
            try {
                // Step 1: Create payment intent for selected method
                const paymentResponse = await fetch('/api/onedream/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        participant_id: currentParticipant.id,
                        vote_count: selectedVoteAmount,
                        payment_method: selectedPaymentMethod
                    })
                });

                if (!paymentResponse.ok) {
                    const errorData = await paymentResponse.json();
                    throw new Error(errorData.error || 'Failed to create payment');
                }

                const paymentData = await paymentResponse.json();

                // Step 2: Process payment based on selected method
                let paymentResult;
                switch (selectedPaymentMethod) {
                    case 'stripe':
                        paymentResult = await processStripePayment(paymentData);
                        break;
                    case 'paystack':
                        paymentResult = await processPaystackPayment(paymentData);
                        break;
                    case 'crypto':
                        paymentResult = await processCryptoPayment(paymentData);
                        break;
                    default:
                        throw new Error('Unsupported payment method');
                }

                // Step 3: If payment successful, record votes
                if (paymentResult.success) {
                    await recordVotesAfterPayment(paymentResult.payment_intent_id);
                } else {
                    throw new Error(paymentResult.error || 'Payment was not completed');
                }

            } catch (error) {
                console.error('Payment processing error:', error);
                throw error;
            }
        }

        async function processStripePayment(paymentData) {
            // Initialize Stripe
            const stripe = Stripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY || 'pk_test_...');

            // Confirm payment
            const { error: stripeError, paymentIntent } = await stripe.confirmPayment({
                clientSecret: paymentData.client_secret,
                confirmParams: {
                    return_url: window.location.href,
                },
                redirect: 'if_required'
            });

            if (stripeError) {
                return { success: false, error: `Stripe payment failed: ${stripeError.message}` };
            }

            if (paymentIntent.status === 'succeeded') {
                return { success: true, payment_intent_id: paymentData.payment_intent_id };
            } else {
                return { success: false, error: 'Payment was not completed' };
            }
        }

        async function processPaystackPayment(paymentData) {
            // Redirect to PayStack checkout
            if (paymentData.authorization_url) {
                // Open PayStack in new window
                const paymentWindow = window.open(
                    paymentData.authorization_url, 
                    'PayStack Payment', 
                    'width=600,height=700,scrollbars=yes,resizable=yes'
                );

                // Wait for payment completion (you'd implement proper verification)
                return new Promise((resolve) => {
                    const checkClosed = setInterval(() => {
                        if (paymentWindow.closed) {
                            clearInterval(checkClosed);
                            // In production, verify payment status with PayStack webhook
                            resolve({ success: true, payment_intent_id: paymentData.payment_intent_id });
                        }
                    }, 1000);
                });
            } else {
                return { success: false, error: 'PayStack payment initialization failed' };
            }
        }

        async function processCryptoPayment(paymentData) {
            // Show crypto payment modal
            const confirmed = showCryptoPaymentModal(paymentData);
            
            if (confirmed) {
                return { success: true, payment_intent_id: paymentData.payment_intent_id };
            } else {
                return { success: false, error: 'Crypto payment was cancelled' };
            }
        }

        function showCryptoPaymentModal(paymentData) {
            // Create and show crypto payment modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glassmorphism rounded-2xl p-8 max-w-md w-full text-center">
                    <h3 class="text-2xl font-bold mb-4">Cryptocurrency Payment</h3>
                    <div class="mb-4">
                        <img src="${paymentData.qr_code_url}" alt="Payment QR Code" class="mx-auto mb-4 rounded-lg">
                        <p class="text-sm mb-2">Send exactly:</p>
                        <div class="bg-white/10 p-3 rounded-lg mb-2">
                            <code class="text-sm">${paymentData.amount_btc} BTC</code>
                        </div>
                        <div class="bg-white/10 p-3 rounded-lg mb-4">
                            <code class="text-sm">${paymentData.crypto_address}</code>
                        </div>
                        <p class="text-xs text-white/60">${paymentData.instructions}</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg transition-colors flex-1">
                            Cancel
                        </button>
                        <button onclick="confirmCryptoPayment(this)" 
                                class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg transition-colors flex-1">
                            Payment Sent
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            return new Promise((resolve) => {
                window.confirmCryptoPayment = function(button) {
                    modal.remove();
                    resolve(true);
                };
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });
            });
        }

        async function recordVotesAfterPayment(paymentIntentId) {
            // Get voter information for analytics
            const voterInfo = {
                ip: await getClientIP(),
                userAgent: navigator.userAgent
            };

            // Call the vote API with confirmed payment
            const response = await fetch('/api/onedream/vote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    participant_id: currentParticipant.id,
                    vote_count: selectedVoteAmount,
                    payment_amount: selectedCost,
                    payment_method: 'stripe',
                    payment_intent_id: paymentIntentId,
                    payment_status: 'completed',
                    voter_info: voterInfo
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to record votes after payment');
            }

            const data = await response.json();
            
            // Update current participant data with response
            if (data.participant) {
                currentParticipant.total_votes = data.participant.total_votes;
            }
            
            console.log('‚úÖ Payment processed and votes recorded:', data);
            return data;
        }

        // Helper function to get client IP (best effort)
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.warn('Could not get client IP:', error);
                return null;
            }
        }

        function showSuccessModal() {
            document.getElementById('successParticipantName').textContent = currentParticipant.name;
            document.getElementById('successVoteCount').textContent = selectedVoteAmount;
            document.getElementById('successModal').classList.remove('hidden');
            
            // Update participant display
            showParticipant();
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            
            // Reset vote selection to 1 vote
            selectedVoteAmount = 1;
            selectedCost = 2.00;
            document.getElementById('customVoteAmount').value = '';
            
            // Re-select first option
            const buttons = document.querySelectorAll('.vote-amount-btn');
            buttons.forEach(btn => btn.classList.remove('border-blue-500', 'bg-blue-500/30'));
            buttons[0].classList.add('border-blue-500', 'bg-blue-500/30');
            
            updateUI();
        }

        // Sharing functions
        function shareOnTwitter() {
            const text = `I just voted for ${currentParticipant.name} in the One Dream Initiative! üåü Help them reach their goal of 1M votes!`;
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function shareOnFacebook() {
            const url = window.location.href;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        function copyVoteLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Vote link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function generateUserCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        console.log('üó≥Ô∏è One Dream Initiative Vote Page loaded');
        console.log('üîê Using secure configuration from environment variables');
    </script>
</body>
</html>