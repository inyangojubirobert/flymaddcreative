// Wait for an existing Paystack inline script to expose PaystackPop.
// Do NOT fetch/import inline.js here; vote.html should load it with a <script> tag.
async function ensurePaystack(timeout = 5000) {
    if (typeof window === 'undefined') throw new Error('Browser environment required');
    if (window.PaystackPop) return;
    if (window._paystackLoading) return window._paystackLoading;

    window._paystackLoading = new Promise((resolve, reject) => {
        const start = Date.now();
        (function wait() {
            if (window.PaystackPop) return resolve();
            if (Date.now() - start > timeout) return reject(new Error('PaystackPop not available after wait'));
            setTimeout(wait, 50);
        })();
    });

    return window._paystackLoading;
}

async function processPaystackPayment() {
    const participantId = window.currentParticipant?.id;
    const voteCount = window.selectedVoteAmount;

    if (!participantId || !voteCount) {
        alert('Missing participant info or vote amount.');
        return { success: false, error: 'Missing metadata' };
    }

    try {
        const res = await fetch('/api/onedream/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ participant_id: participantId, vote_count: voteCount, payment_method: 'paystack' })
        });

        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            console.error('create-payment-intent failed:', err);
            throw new Error(err.error || 'Failed to initialize Paystack payment');
        }

        const data = await res.json();
        console.debug('Paystack init response:', data);

        // Determine Paystack public key: prefer explicit window var, otherwise server-provided value
        const configuredKey = (typeof window.PAYSTACK_PUBLIC_KEY === 'string' && window.PAYSTACK_PUBLIC_KEY.trim()) ? window.PAYSTACK_PUBLIC_KEY.trim() : (data.public_key || '');
        // Basic validation: Paystack public keys typically start with "pk_"
        const keyLooksValid = typeof configuredKey === 'string' && configuredKey.length > 10 && /^pk_/.test(configuredKey);

        if (!keyLooksValid) {
            // EXPLANATION: The inline flow requires a valid client (public) key.
            // The server-side redirect (authorization_url) is generated by your backend using the secret key,
            // so it can succeed even if the client public key is missing. That is why a redirect may still work.
            // We should NOT auto-redirect the user without consent. Prompt instead.
            console.error('Paystack public key missing or invalid:', configuredKey);
            const canRedirect = typeof data.authorization_url === 'string' && data.authorization_url.startsWith('http');
            const userChoice = confirm('Payment setup error: Paystack public key is missing or invalid. The site can fall back to a server-hosted checkout page. Do you want to proceed to the external checkout?');
            if (userChoice && canRedirect) {
                // Log reason for support/debugging
                console.info('User accepted redirect fallback to authorization_url (server-side flow). Note: server used secret key to create this URL.');
                window.location.href = data.authorization_url;
                return { success: true, redirect: true, url: data.authorization_url };
            }
            // If user declined or no authorization_url, surface error
            return { success: false, error: 'Invalid Paystack public key; inline checkout unavailable' };
        }

        // Determine amount in kobo (server may return amount_kobo or amount)
        let amountKobo = null;
        if (typeof data.amount_kobo === 'number' && Number.isFinite(data.amount_kobo)) {
            amountKobo = data.amount_kobo;
        } else if (typeof data.amount === 'number' && Number.isFinite(data.amount)) {
            amountKobo = Math.round(data.amount * 100);
        } else if (typeof data.amount === 'string' && !isNaN(Number(data.amount))) {
            amountKobo = Math.round(Number(data.amount) * 100);
        }

        if (!amountKobo || amountKobo <= 0) {
            console.warn('Invalid or missing amount from server:', data);
            if (data.authorization_url) {
                window.location.href = data.authorization_url;
                return { success: true, redirect: true, url: data.authorization_url };
            }
            return { success: false, error: 'Invalid payment amount from server' };
        }

        // Ensure inline SDK is available if you rely on inline
        try {
            await ensurePaystack();
        } catch (e) {
            console.warn('Paystack inline SDK not available or blocked:', e);
            if (data.authorization_url) {
                window.location.href = data.authorization_url;
                return { success: true, redirect: true, url: data.authorization_url };
            }
            return { success: false, error: 'Paystack SDK unavailable' };
        }

        if (typeof window.PaystackPop === 'undefined') {
            console.warn('PaystackPop global not present after ensurePaystack.');
            if (data.authorization_url) {
                window.location.href = data.authorization_url;
                return { success: true, redirect: true, url: data.authorization_url };
            }
            return { success: false, error: 'PaystackPop not defined' };
        }

        const key = configuredKey;
        const email = (window.currentUser && window.currentUser.email) || 'support@flymaddcreative.online';

        return await new Promise((resolve) => {
            const options = {
                key,
                email,
                amount: amountKobo,
                reference: data.reference || data.payment_intent_id,
                callback: function (response) {
                    resolve({ success: true, payment_intent_id: response.reference, raw: response, redirect: false });
                },
                onClose: function () {
                    resolve({ success: false, error: 'User closed Paystack dialog', redirect: false });
                }
            };

            try {
                let handler = null;
                if (typeof window.PaystackPop.setup === 'function') {
                    handler = window.PaystackPop.setup(options);
                } else if (typeof window.PaystackPop === 'function') {
                    try { handler = new window.PaystackPop(options); } catch (e) { handler = window.PaystackPop(options); }
                }

                if (handler && typeof handler.openIframe === 'function') {
                    try {
                        handler.openIframe();
                    } catch (popupErr) {
                        console.warn('Paystack inline popup failed to open (fallback to redirect):', popupErr);
                        if (data.authorization_url) {
                            window.location.href = data.authorization_url;
                            resolve({ success: true, redirect: true, url: data.authorization_url });
                        } else {
                            resolve({ success: false, error: 'Paystack popup failed and no redirect available' });
                        }
                    }
                } else {
                    if (data.authorization_url) {
                        window.location.href = data.authorization_url;
                        resolve({ success: true, redirect: true, url: data.authorization_url });
                    } else {
                        resolve({ success: false, error: 'Paystack handler unavailable' });
                    }
                }
            } catch (err) {
                console.error('Paystack inline error:', err);
                if (data.authorization_url) {
                    window.location.href = data.authorization_url;
                    resolve({ success: true, redirect: true, url: data.authorization_url });
                } else {
                    resolve({ success: false, error: err.message });
                }
            }
        });

    } catch (err) {
        console.error('Paystack payment error:', err);
        return { success: false, error: err.message || 'Unknown Paystack error' };
    }
}

// Export to window for vote.js to call
window.ensurePaystack = ensurePaystack;
window.processPaystackPayment = processPaystackPayment;
