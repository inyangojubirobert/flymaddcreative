<script>
/* =========================================================
   ONE DREAM INITIATIVE ‚Äì SECURE WEB3 PAYMENT SCRIPT
   Supports:
   - BSC USDT (Injected wallets + WalletConnect QR)
   - TRON USDT (TronLink / tronWeb)
   No secrets exposed. Backend-driven payments.
   ========================================================= */

console.log('üöÄ Secure Web3 Script Loaded');

/* ---------------- GLOBAL STATE ---------------- */

window.Web3State = {
  provider: null,
  signer: null,
  address: null,
  chainId: null,
  network: null, // 'bsc' | 'tron'
  wcProvider: null,
  config: null
};

/* ---------------- UTILITIES ---------------- */

async function loadScriptOnce(src) {
  return new Promise((resolve, reject) => {
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = resolve;
    s.onerror = () => reject(new Error(`Failed to load ${src}`));
    document.head.appendChild(s);
  });
}

async function loadConfig() {
  if (window.Web3State.config) return window.Web3State.config;
  const res = await fetch('/api/onedream/get-payment-config');
  if (!res.ok) throw new Error('Failed to load payment config');
  window.Web3State.config = await res.json();
  return window.Web3State.config;
}

/* ---------------- BSC ‚Äì INJECTED WALLET ---------------- */

async function connectBSCInjected() {
  await loadScriptOnce('https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js');

  if (!window.ethereum) {
    throw new Error('No BSC-compatible wallet detected');
  }

  const provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send('eth_requestAccounts', []);

  const network = await provider.getNetwork();
  if (Number(network.chainId) !== 56) {
    throw new Error('Please switch your wallet to Binance Smart Chain (BSC)');
  }

  const signer = await provider.getSigner();
  const address = await signer.getAddress();

  Object.assign(window.Web3State, {
    provider,
    signer,
    address,
    chainId: 56,
    network: 'bsc'
  });

  console.log('‚úÖ Connected BSC injected wallet:', address);
  return address;
}

/* ---------------- BSC ‚Äì WALLETCONNECT QR ---------------- */

async function connectBSCWalletConnect() {
  await loadScriptOnce('https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js');

  const { EthereumProvider } = await import(
    'https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.11.0/+esm'
  );

  const config = await loadConfig();

  const wcProvider = await EthereumProvider.init({
    projectId: config.walletconnectProjectId,
    chains: [56],
    showQrModal: true,
    methods: ['eth_sendTransaction', 'eth_sign'],
    events: ['accountsChanged', 'chainChanged']
  });

  await wcProvider.connect();

  const provider = new ethers.BrowserProvider(wcProvider);
  const signer = await provider.getSigner();
  const address = await signer.getAddress();
  const network = await provider.getNetwork();

  if (Number(network.chainId) !== 56) {
    throw new Error('Wallet connected but not on BSC');
  }

  Object.assign(window.Web3State, {
    provider,
    signer,
    address,
    chainId: 56,
    network: 'bsc',
    wcProvider
  });

  console.log('‚úÖ Connected BSC via WalletConnect:', address);
  return address;
}

/* ---------------- TRON ‚Äì TRONLINK ---------------- */

async function connectTron() {
  if (!window.tronWeb || !window.tronWeb.ready) {
    throw new Error('TronLink wallet not detected');
  }

  const address = window.tronWeb.defaultAddress.base58;

  Object.assign(window.Web3State, {
    provider: window.tronWeb,
    signer: null,
    address,
    network: 'tron'
  });

  console.log('‚úÖ Connected TRON wallet:', address);
  return address;
}

/* ---------------- PAYMENT INIT ---------------- */

async function initiateCryptoPayment(voteCount) {
  if (!window.Web3State.network || !window.Web3State.address) {
    throw new Error('Wallet not connected');
  }

  const intentRes = await fetch('/api/onedream/init-crypto-payment', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      network: window.Web3State.network,
      votes: voteCount,
      from: window.Web3State.address
    })
  });

  if (!intentRes.ok) {
    throw new Error('Failed to initialize payment');
  }

  const intent = await intentRes.json();

  if (window.Web3State.network === 'bsc') {
    return sendBSCUSDT(intent);
  }

  if (window.Web3State.network === 'tron') {
    return sendTRONUSDT(intent);
  }

  throw new Error('Unsupported network');
}

/* ---------------- SEND USDT ‚Äì BSC ---------------- */

async function sendBSCUSDT(intent) {
  const usdt = new ethers.Contract(
    intent.token,
    ['function transfer(address,uint256) returns (bool)'],
    window.Web3State.signer
  );

  const tx = await usdt.transfer(intent.to, intent.amount);
  console.log('‚è≥ BSC TX sent:', tx.hash);

  await tx.wait();
  console.log('‚úÖ BSC TX confirmed:', tx.hash);

  return tx.hash;
}

/* ---------------- SEND USDT ‚Äì TRON ---------------- */

async function sendTRONUSDT(intent) {
  const tronWeb = window.Web3State.provider;
  const contract = await tronWeb.contract().at(intent.token);

  const tx = await contract.transfer(
    intent.to,
    intent.amount
  ).send();

  console.log('‚úÖ TRON TX sent:', tx);
  return tx;
}

/* ---------------- SAFE DISCONNECT ---------------- */

async function disconnectWallet() {
  if (window.Web3State.wcProvider) {
    await window.Web3State.wcProvider.disconnect();
  }

  window.Web3State = {
    provider: null,
    signer: null,
    address: null,
    chainId: null,
    network: null,
    wcProvider: null,
    config: window.Web3State.config
  };

  console.log('üîå Wallet disconnected');
}
</script>
