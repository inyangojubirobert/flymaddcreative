<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Payment Integration - One Dream Initiative</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="max-w-2xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Vote for Participant</h1>
            
            <!-- Participant Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Participant</label>
                <select id="username" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">Choose a participant...</option>
                    <option value="johndoe">John Doe</option>
                    <option value="janesmith">Jane Smith</option>
                    <option value="bobwilson">Bob Wilson</option>
                </select>
            </div>

            <!-- Vote Amount -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Votes ($2 each)</label>
                <div class="flex items-center space-x-4">
                    <input type="number" id="voteCount" min="1" value="5" 
                           class="flex-1 p-3 border border-gray-300 rounded-lg">
                    <span class="text-lg font-semibold text-green-600" id="totalAmount">$10.00</span>
                </div>
                <p class="text-sm text-gray-500 mt-1">Each vote costs $2.00</p>
            </div>

            <!-- Payment Buttons -->
            <div class="space-y-4">
                <button id="stripePayment" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200">
                    ðŸ’³ Pay with Stripe
                </button>
                
                <button id="cryptoPayment" 
                        class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-lg transition duration-200">
                    â‚¿ Pay with Crypto
                </button>
                
                <button id="customPayment" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-lg transition duration-200">
                    ðŸ”§ Custom Payment (Test)
                </button>
            </div>

            <!-- Status Display -->
            <div id="status" class="mt-6 p-4 rounded-lg hidden">
                <p id="statusMessage"></p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const STRIPE_PUBLIC_KEY = 'pk_test_your_stripe_public_key'; // Replace with your Stripe public key
        const SUPABASE_URL = 'https://your-project.supabase.co'; // Replace with your Supabase URL
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLIC_KEY);

        // DOM elements
        const usernameSelect = document.getElementById('username');
        const voteCountInput = document.getElementById('voteCount');
        const totalAmountSpan = document.getElementById('totalAmount');
        const statusDiv = document.getElementById('status');
        const statusMessage = document.getElementById('statusMessage');

        // Update total amount when vote count changes
        voteCountInput.addEventListener('input', updateTotal);
        
        function updateTotal() {
            const voteCount = parseInt(voteCountInput.value) || 0;
            const total = voteCount * 2;
            totalAmountSpan.textContent = `$${total.toFixed(2)}`;
        }

        function showStatus(message, isError = false) {
            statusDiv.className = `mt-6 p-4 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            statusMessage.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        function hideStatus() {
            statusDiv.classList.add('hidden');
        }

        // Stripe Payment
        document.getElementById('stripePayment').addEventListener('click', async () => {
            const username = usernameSelect.value;
            const voteCount = parseInt(voteCountInput.value);
            
            if (!username) {
                showStatus('Please select a participant', true);
                return;
            }
            
            if (voteCount < 1) {
                showStatus('Please enter a valid number of votes', true);
                return;
            }

            hideStatus();

            try {
                // Create Stripe Checkout Session
                const response = await fetch('/create-checkout-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        voteCount: voteCount,
                        amount: voteCount * 200, // Convert to cents
                    })
                });

                const session = await response.json();
                
                if (session.error) {
                    showStatus(session.error, true);
                    return;
                }

                // Redirect to Stripe Checkout
                const result = await stripe.redirectToCheckout({
                    sessionId: session.id
                });

                if (result.error) {
                    showStatus(result.error.message, true);
                }
            } catch (error) {
                showStatus('Payment failed: ' + error.message, true);
            }
        });

        // Crypto Payment (Mock - integrate with your crypto payment provider)
        document.getElementById('cryptoPayment').addEventListener('click', () => {
            const username = usernameSelect.value;
            const voteCount = parseInt(voteCountInput.value);
            
            if (!username) {
                showStatus('Please select a participant', true);
                return;
            }

            // This would typically redirect to a crypto payment provider
            // like Coinbase Commerce, BitPay, or CoinGate
            showStatus(`Crypto payment for ${voteCount} votes ($${voteCount * 2}) would be processed here`);
        });

        // Custom Payment (Test Function)
        document.getElementById('customPayment').addEventListener('click', async () => {
            const username = usernameSelect.value;
            const voteCount = parseInt(voteCountInput.value);
            
            if (!username) {
                showStatus('Please select a participant', true);
                return;
            }

            hideStatus();

            try {
                // Simulate a custom payment
                const transactionId = 'test_' + Date.now();
                const amount = voteCount * 2;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/process-vote-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'payment.completed',
                        data: {
                            transaction_id: transactionId,
                            username: username,
                            amount: amount,
                            currency: 'USD',
                            payment_method: 'test',
                            payer_email: 'test@example.com',
                            payer_name: 'Test User',
                            status: 'completed'
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showStatus(`Success! ${result.votes_added} votes added for ${result.participant_name}`);
                } else {
                    showStatus(result.error || 'Payment failed', true);
                }
            } catch (error) {
                showStatus('Test payment failed: ' + error.message, true);
            }
        });

        // Initialize
        updateTotal();
    </script>
</body>
</html>